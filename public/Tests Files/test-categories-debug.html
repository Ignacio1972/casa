<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug de Categorías - MBI v4</title>
    <!-- Cargar estilos principales -->
    <link rel="stylesheet" href="/styles-v5/main.css">
</head>
<body>
    <div class="container" style="padding: 2rem;">
        <h1>Debug de Categorías y Badges</h1>
        
        <div style="margin: 2rem 0;">
            <h2>1. Test de Clases CSS</h2>
            <p>Probando cada clase de badge directamente:</p>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin: 1rem 0;">
                <span class="badge badge-ofertas">Ofertas (badge-ofertas)</span>
                <span class="badge badge-eventos">Eventos (badge-eventos)</span>
                <span class="badge badge-informacion">Info (badge-informacion)</span>
                <span class="badge badge-servicios">Servicios (badge-servicios)</span>
                <span class="badge badge-horarios">Horarios (badge-horarios)</span>
                <span class="badge badge-emergencias">Emergencias (badge-emergencias)</span>
                <span class="badge badge-sin-categoria">Sin Cat (badge-sin-categoria)</span>
                <span class="badge badge-sin_categoria">Sin Cat (badge-sin_categoria)</span>
            </div>
        </div>

        <div style="margin: 2rem 0;">
            <h2>2. Test con message-badge</h2>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin: 1rem 0;">
                <span class="message-badge badge-ofertas">Ofertas</span>
                <span class="message-badge badge-eventos">Eventos</span>
                <span class="message-badge badge-informacion">Info</span>
                <span class="message-badge badge-servicios">Servicios</span>
                <span class="message-badge badge-horarios">Horarios</span>
                <span class="message-badge badge-emergencias">Emergencias</span>
                <span class="message-badge badge-sin-categoria">Sin Cat (guión)</span>
                <span class="message-badge badge-sin_categoria">Sin Cat (underscore)</span>
            </div>
        </div>

        <div style="margin: 2rem 0;">
            <h2>3. Verificación de Estilos Cargados</h2>
            <button onclick="checkStyles()">Verificar Estilos CSS</button>
            <pre id="styles-output" style="background: #f0f0f0; padding: 1rem; margin-top: 1rem;"></pre>
        </div>

        <div style="margin: 2rem 0;">
            <h2>4. Test de Datos desde API</h2>
            <button onclick="fetchMessages()">Cargar Mensajes Guardados</button>
            <div id="messages-output" style="margin-top: 1rem;"></div>
        </div>

        <div style="margin: 2rem 0;">
            <h2>5. Test de Renderizado Campaign</h2>
            <button onclick="testCampaignRender()">Test Renderizado Campaign</button>
            <div id="campaign-output" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <script>
        // Función para verificar estilos CSS
        function checkStyles() {
            const output = document.getElementById('styles-output');
            const results = [];
            
            // Verificar si existen las clases CSS
            const categories = ['ofertas', 'eventos', 'informacion', 'servicios', 'horarios', 'emergencias', 'sin-categoria', 'sin_categoria'];
            
            categories.forEach(cat => {
                const testEl = document.createElement('span');
                testEl.className = `badge badge-${cat}`;
                document.body.appendChild(testEl);
                const style = window.getComputedStyle(testEl);
                results.push({
                    class: `badge-${cat}`,
                    background: style.backgroundColor,
                    color: style.color,
                    exists: style.backgroundColor !== 'rgba(0, 0, 0, 0)'
                });
                testEl.remove();
            });
            
            output.textContent = JSON.stringify(results, null, 2);
            
            // Verificar archivos CSS cargados
            const links = Array.from(document.querySelectorAll('link[rel="stylesheet"]'));
            console.log('Archivos CSS cargados:', links.map(l => l.href));
        }

        // Función para cargar mensajes desde la API
        async function fetchMessages() {
            const output = document.getElementById('messages-output');
            try {
                const response = await fetch('/api/saved-messages.php');
                const data = await response.json();
                
                if (data.success) {
                    output.innerHTML = '<h3>Mensajes cargados:</h3>';
                    data.messages.forEach(msg => {
                        output.innerHTML += `
                            <div style="margin: 0.5rem; padding: 0.5rem; border: 1px solid #ccc;">
                                <strong>${msg.title}</strong><br>
                                Categoría raw: "${msg.category}"<br>
                                Tipo: ${typeof msg.category}<br>
                                <span class="badge badge-${msg.category}">Test directo: ${msg.category}</span>
                                <span class="badge badge-${(msg.category || 'sin-categoria').replace(/_/g, '-')}">Test convertido: ${msg.category}</span>
                            </div>
                        `;
                    });
                    
                    console.log('Mensajes cargados:', data.messages);
                    console.log('Categorías únicas:', [...new Set(data.messages.map(m => m.category))]);
                }
            } catch (error) {
                output.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        // Test de renderizado como lo hace campaigns
        function testCampaignRender() {
            const output = document.getElementById('campaign-output');
            
            // Simular mensajes como los recibe campaigns
            const testMessages = [
                { id: 1, title: 'Test Ofertas', category: 'ofertas' },
                { id: 2, title: 'Test Eventos', category: 'eventos' },
                { id: 3, title: 'Test Sin Cat', category: 'sin_categoria' },
                { id: 4, title: 'Test Info', category: 'informacion' },
                { id: 5, title: 'Test null', category: null },
                { id: 6, title: 'Test undefined', category: undefined }
            ];
            
            output.innerHTML = '<h3>Renderizado tipo Campaign:</h3>';
            
            testMessages.forEach(msg => {
                // Exactamente como lo hace campaigns/index.js línea 482
                const categoryClass = `badge-${msg.category || 'sin-categoria'}`;
                
                output.innerHTML += `
                    <div style="margin: 0.5rem; padding: 0.5rem; border: 1px solid #ccc;">
                        <strong>${msg.title}</strong><br>
                        Categoría: ${msg.category}<br>
                        Clase generada: ${categoryClass}<br>
                        <span class="message-badge ${categoryClass}">Badge renderizado</span>
                    </div>
                `;
            });
            
            console.log('Test messages:', testMessages);
        }

        // Ejecutar verificación automática al cargar
        window.addEventListener('load', () => {
            console.log('=== DEBUG DE CATEGORÍAS ===');
            console.log('Verificando módulo campaigns:', window.campaignLibrary);
            
            // Verificar si hay mensajes en memoria
            if (window.campaignLibrary && window.campaignLibrary.messages) {
                console.log('Mensajes en memoria:', window.campaignLibrary.messages);
                console.log('Categorías en memoria:', 
                    window.campaignLibrary.messages.map(m => ({
                        title: m.title,
                        category: m.category,
                        type: typeof m.category
                    }))
                );
            }
        });
    </script>
</body>
</html>